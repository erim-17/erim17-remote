const express = require('express');
const http = require('http');
const { Server } = require('socket.io');
const cors = require('cors');

const app = express();
app.use(cors());
app.use(express.json());

// Health check
app.get('/health', (req, res) => {
  res.status(200).json({
    status: 'healthy',
    service: 'asfat-remote',
    version: '2.0.0',
    timestamp: new Date().toISOString(),
    features: ['screen-sharing', 'remote-control', 'chat']
  });
});

app.get('/', (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>🚀 ASFAT Remote Server v2.0</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 40px; text-align: center; }
        h1 { color: #333; }
        .features { display: flex; justify-content: center; gap: 20px; margin: 30px 0; }
        .feature { background: #f0f0f0; padding: 15px; border-radius: 10px; }
      </style>
    </head>
    <body>
      <h1>🚀 ASFAT Remote Server v2.0</h1>
      <p>Real-time screen sharing and remote control</p>
      <div class="features">
        <div class="feature">✅ Screen Sharing</div>
        <div class="feature">✅ Remote Control</div>
        <div class="feature">✅ Chat</div>
      </div>
      <p><a href="/health">Health Check</a></p>
    </body>
    </html>
  `);
});

const server = http.createServer(app);
const io = new Server(server, {
  cors: {
    origin: "*",
    methods: ["GET", "POST"]
  },
  pingTimeout: 60000,
  pingInterval: 25000
});

// Oda yönetimi
const rooms = new Map();
const userConnections = new Map();

io.on('connection', (socket) => {
  console.log(`🔗 New connection: ${socket.id} (IP: ${socket.handshake.address})`);

  // ========== ODAYA KATIL ==========
  socket.on('join-room', (roomId, username) => {
    try {
      if (!roomId || roomId.length < 3) {
        socket.emit('error', { message: 'Invalid room ID' });
        return;
      }

      // Eski odadan çık
      const oldRoom = userConnections.get(socket.id);
      if (oldRoom && oldRoom !== roomId) {
        socket.leave(oldRoom);
        leaveRoom(oldRoom, socket.id);
      }

      // Yeni odaya katıl
      socket.join(roomId);
      userConnections.set(socket.id, roomId);

      const room = rooms.get(roomId) || {
        id: roomId,
        peers: new Map(),
        created: Date.now(),
        screenSharing: null
      };

      // Kullanıcı bilgilerini kaydet
      room.peers.set(socket.id, {
        id: socket.id,
        username: username || `User_${socket.id.substring(0, 6)}`,
        joined: Date.now(),
        isSharing: false
      });

      rooms.set(roomId, room);

      // Yeni kullanıcıya odadaki diğerlerini gönder
      const otherPeers = Array.from(room.peers.values())
        .filter(p => p.id !== socket.id)
        .map(p => ({ id: p.id, username: p.username, isSharing: p.isSharing }));

      socket.emit('room-joined', {
        roomId,
        yourId: socket.id,
        peers: otherPeers,
        screenSharing: room.screenSharing,
        roomSize: room.peers.size
      });

      // Diğerlerine yeni kullanıcıyı bildir
      socket.to(roomId).emit('peer-joined', {
        peerId: socket.id,
        username: room.peers.get(socket.id).username,
        timestamp: Date.now()
      });

      console.log(`📦 ${socket.id} joined room ${roomId} (${room.peers.size} users)`);

    } catch (error) {
      console.error('Join room error:', error);
      socket.emit('error', { message: 'Server error' });
    }
  });

  // ========== EKRAN PAYLAŞIMI ==========
  socket.on('start-screen-share', (roomId) => {
    const room = rooms.get(roomId);
    if (room && room.peers.has(socket.id)) {
      room.screenSharing = socket.id;
      room.peers.get(socket.id).isSharing = true;
      
      // Odadaki herkese bildir
      io.to(roomId).emit('screen-sharing-started', {
        peerId: socket.id,
        username: room.peers.get(socket.id).username,
        timestamp: Date.now()
      });
      
      console.log(`📺 ${socket.id} started screen sharing in ${roomId}`);
    }
  });

  socket.on('stop-screen-share', (roomId) => {
    const room = rooms.get(roomId);
    if (room) {
      room.screenSharing = null;
      if (room.peers.has(socket.id)) {
        room.peers.get(socket.id).isSharing = false;
      }
      
      io.to(roomId).emit('screen-sharing-stopped', {
        peerId: socket.id,
        timestamp: Date.now()
      });
      
      console.log(`⏹️ ${socket.id} stopped screen sharing in ${roomId}`);
    }
  });

  // ========== EKRAN VERİSİ GÖNDERME ==========
  socket.on('send-screen-data', ({ roomId, imageData, timestamp }) => {
    // Sadece ekran paylaşan kişi gönderebilir
    const room = rooms.get(roomId);
    if (room && room.screenSharing === socket.id) {
      // Odadaki diğer herkese gönder (gönderen hariç)
      socket.to(roomId).emit('receive-screen-data', {
        from: socket.id,
        imageData: imageData,
        timestamp: timestamp || Date.now(),
        size: imageData.length
      });
    }
  });

  // ========== KONTROL OLAYLARI ==========
  socket.on('send-control-event', ({ roomId, eventType, data }) => {
    // Odadaki ekran paylaşana gönder
    const room = rooms.get(roomId);
    if (room && room.screenSharing) {
      io.to(room.screenSharing).emit('receive-control-event', {
        from: socket.id,
        eventType: eventType,
        data: data,
        timestamp: Date.now()
      });
    }
  });

  // ========== MESAJLAŞMA ==========
  socket.on('send-message', ({ roomId, message }) => {
    if (!message || !roomId) return;
    
    const room = rooms.get(roomId);
    if (room && room.peers.has(socket.id)) {
      const user = room.peers.get(socket.id);
      const messageData = {
        id: Date.now().toString(),
        from: socket.id,
        username: user.username,
        message: message.substring(0, 500),
        timestamp: Date.now()
      };
      
      // Odadaki herkese gönder
      io.to(roomId).emit('new-message', messageData);
    }
  });

  // ========== BAĞLANTI KESİLİNCE ==========
  socket.on('disconnect', () => {
    console.log(`❌ Disconnected: ${socket.id}`);
    
    const roomId = userConnections.get(socket.id);
    if (roomId) {
      leaveRoom(roomId, socket.id);
      userConnections.delete(socket.id);
    }
  });

  // ========== PING/PONG (bağlantı kontrolü) ==========
  socket.on('ping', () => {
    socket.emit('pong', { timestamp: Date.now() });
  });
});

// Yardımcı fonksiyonlar
function leaveRoom(roomId, socketId) {
  const room = rooms.get(roomId);
  if (!room) return;

  const user = room.peers.get(socketId);
  room.peers.delete(socketId);

  // Eğer ekran paylaşıyorsa durdur
  if (room.screenSharing === socketId) {
    room.screenSharing = null;
    io.to(roomId).emit('screen-sharing-stopped', {
      peerId: socketId,
      timestamp: Date.now()
    });
  }

  // Odadaki diğerlerine bildir
  io.to(roomId).emit('peer-left', {
    peerId: socketId,
    username: user?.username,
    timestamp: Date.now()
  });

  // Oda boşsa sil
  if (room.peers.size === 0) {
    rooms.delete(roomId);
    console.log(`🗑️ Room ${roomId} deleted (empty)`);
  } else {
    console.log(`👋 ${socketId} left room ${roomId} (${room.peers.size} users remaining)`);
  }
}

const PORT = process.env.PORT || 10000;
server.listen(PORT, () => {
  console.log(`🚀 ASFAT Remote Server v2.0 running on port ${PORT}`);
  console.log(`📡 Ready for screen sharing`);
  console.log(`🌐 Health: http://localhost:${PORT}/health`);
});